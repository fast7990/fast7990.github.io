<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H5 FFmpeg éŸ³è§†é¢‘å¤„ç†å·¥å…·</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: #2c3e50;
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.8;
        font-size: 1.1rem;
      }

      .content {
        padding: 30px;
      }

      .upload-section {
        border: 2px dashed #ddd;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        transition: all 0.3s;
      }

      .upload-section:hover {
        border-color: #667eea;
        background: #f8f9fa;
      }

      .upload-section.dragover {
        border-color: #667eea;
        background: #e3f2fd;
      }

      .upload-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
        margin: 10px;
      }

      .upload-btn:hover {
        background: #5a6fd8;
        transform: translateY(-2px);
      }

      .file-input {
        display: none;
      }

      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .control-group {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid #667eea;
      }

      .control-group h3 {
        margin-bottom: 15px;
        color: #2c3e50;
      }

      select,
      input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 10px;
      }

      .preview-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      .preview-box {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
      }

      .preview-box h3 {
        margin-bottom: 15px;
        color: #2c3e50;
      }

      video,
      audio {
        width: 100%;
        max-width: 100%;
        border-radius: 5px;
      }

      .progress-section {
        background: #e8f5e8;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #ddd;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress {
        height: 100%;
        background: #4caf50;
        width: 0%;
        transition: width 0.3s;
      }

      .status {
        text-align: center;
        font-weight: bold;
        color: #2c3e50;
      }

      .download-section {
        text-align: center;
      }

      .download-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 25px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
        display: none;
      }

      .download-btn:hover {
        background: #218838;
        transform: translateY(-2px);
      }

      .info {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        color: #856404;
      }

      @media (max-width: 768px) {
        .preview-section {
          grid-template-columns: 1fr;
        }

        .controls {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ¬ H5 FFmpeg éŸ³è§†é¢‘å¤„ç†å·¥å…·</h1>
        <p>åŸºäºFFmpeg.wasmçš„æµè§ˆå™¨ç«¯éŸ³è§†é¢‘å¤„ç†è§£å†³æ–¹æ¡ˆ</p>
      </div>

      <div class="content">
        <div class="info">
          <strong>æç¤ºï¼š</strong>
          æœ¬å·¥å…·ä½¿ç”¨FFmpeg.wasmåœ¨æµè§ˆå™¨ä¸­ç›´æ¥å¤„ç†éŸ³è§†é¢‘æ–‡ä»¶ï¼Œæ— éœ€ä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚
        </div>

        <div class="upload-section" id="uploadArea">
          <h3>é€‰æ‹©éŸ³è§†é¢‘æ–‡ä»¶</h3>
          <p>æ”¯æŒ MP4, AVI, MOV, MP3, WAV ç­‰æ ¼å¼</p>
          <button
            class="upload-btn"
            onclick="document.getElementById('fileInput').click()"
          >
            é€‰æ‹©æ–‡ä»¶
          </button>
          <input
            type="file"
            id="fileInput"
            class="file-input"
            accept="video/*,audio/*"
          />
          <p>æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
        </div>

        <div class="controls">
          <div class="control-group">
            <h3>è§†é¢‘å¤„ç†é€‰é¡¹</h3>
            <select id="videoAction">
              <option value="convert">æ ¼å¼è½¬æ¢</option>
              <option value="extractAudio">æå–éŸ³é¢‘</option>
              <option value="compress">å‹ç¼©è§†é¢‘</option>
              <option value="trim">è£å‰ªè§†é¢‘</option>
            </select>
            <select id="outputFormat">
              <option value="mp4">MP4</option>
              <option value="webm">WebM</option>
              <option value="avi">AVI</option>
              <option value="mov">MOV</option>
            </select>
          </div>

          <div class="control-group">
            <h3>éŸ³é¢‘å¤„ç†é€‰é¡¹</h3>
            <select id="audioAction">
              <option value="convert">æ ¼å¼è½¬æ¢</option>
              <option value="trim">è£å‰ªéŸ³é¢‘</option>
              <option value="merge">åˆå¹¶éŸ³é¢‘</option>
            </select>
            <select id="audioFormat">
              <option value="mp3">MP3</option>
              <option value="wav">WAV</option>
              <option value="ogg">OGG</option>
              <option value="aac">AAC</option>
            </select>
          </div>

          <div class="control-group">
            <h3>é«˜çº§è®¾ç½®</h3>
            <input
              type="number"
              id="startTime"
              placeholder="å¼€å§‹æ—¶é—´(ç§’)"
              min="0"
            />
            <input
              type="number"
              id="endTime"
              placeholder="ç»“æŸæ—¶é—´(ç§’)"
              min="0"
            />
            <input
              type="number"
              id="quality"
              placeholder="è´¨é‡(1-100)"
              min="1"
              max="100"
              value="80"
            />
          </div>
        </div>

        <div class="preview-section">
          <div class="preview-box">
            <h3>åŸå§‹æ–‡ä»¶é¢„è§ˆ</h3>
            <div id="originalPreview"></div>
          </div>
          <div class="preview-box">
            <h3>å¤„ç†åé¢„è§ˆ</h3>
            <div id="processedPreview"></div>
          </div>
        </div>

        <div class="progress-section">
          <h3>å¤„ç†è¿›åº¦</h3>
          <div class="progress-bar">
            <div class="progress" id="progressBar"></div>
          </div>
          <div class="status" id="status">ç­‰å¾…æ–‡ä»¶ä¸Šä¼ ...</div>
        </div>

        <div class="download-section">
          <button class="download-btn" id="downloadBtn">
            ä¸‹è½½å¤„ç†åçš„æ–‡ä»¶
          </button>
        </div>
      </div>
    </div>

    <!-- å¼•å…¥FFmpeg.wasm -->
    <!-- <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ffmpeg/0.12.15/umd/ffmpeg.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.2/dist/ffmpeg-core.js"></script> -->
    <script type="module">
      import { FFmpeg } from "https://cdnjs.cloudflare.com/ajax/libs/ffmpeg/0.12.15/umd/ffmpeg.min.js";
      console.log(FFmpeg);
      // FFmpegå®ä¾‹
      let ffmpeg = null;
      let originalFile = null;

      // åˆå§‹åŒ–FFmpeg
      async function initFFmpeg() {
        const { createFFmpeg, fetchFile } = FFmpeg;
        ffmpeg = createFFmpeg({
          log: true,
          progress: ({ ratio }) => {
            const progress = Math.round(ratio * 100);
            document.getElementById("progressBar").style.width = progress + "%";
            document.getElementById(
              "status"
            ).textContent = `å¤„ç†ä¸­: ${progress}%`;
          },
        });

        await ffmpeg.load();
        document.getElementById("status").textContent =
          "FFmpeg åŠ è½½å®Œæˆï¼Œå‡†å¤‡å°±ç»ª";
      }

      // æ–‡ä»¶ä¸Šä¼ å¤„ç†
      document
        .getElementById("fileInput")
        .addEventListener("change", handleFileSelect);
      const uploadArea = document.getElementById("uploadArea");

      // æ‹–æ‹½åŠŸèƒ½
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        if (e.dataTransfer.files.length) {
          handleFile(e.dataTransfer.files[0]);
        }
      });

      function handleFileSelect(e) {
        if (e.target.files.length) {
          handleFile(e.target.files[0]);
        }
      }

      function handleFile(file) {
        originalFile = file;
        document.getElementById(
          "status"
        ).textContent = `æ–‡ä»¶å·²é€‰æ‹©: ${file.name}`;

        // é¢„è§ˆåŸå§‹æ–‡ä»¶
        previewFile(file, "originalPreview");

        // æ˜¾ç¤ºå¤„ç†æŒ‰é’®
        document.getElementById("downloadBtn").style.display = "inline-block";
      }

      function previewFile(file, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        if (file.type.startsWith("video/")) {
          const video = document.createElement("video");
          video.controls = true;
          video.src = URL.createObjectURL(file);
          video.style.maxWidth = "100%";
          container.appendChild(video);
        } else if (file.type.startsWith("audio/")) {
          const audio = document.createElement("audio");
          audio.controls = true;
          audio.src = URL.createObjectURL(file);
          audio.style.width = "100%";
          container.appendChild(audio);
        } else {
          container.innerHTML = `<p>ä¸æ”¯æŒé¢„è§ˆæ­¤æ–‡ä»¶ç±»å‹</p>`;
        }
      }

      // å¤„ç†æ–‡ä»¶
      document
        .getElementById("downloadBtn")
        .addEventListener("click", processFile);

      async function processFile() {
        if (!originalFile || !ffmpeg) {
          alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¹¶ç­‰å¾…FFmpegåŠ è½½å®Œæˆ");
          return;
        }

        try {
          document.getElementById("status").textContent = "å¼€å§‹å¤„ç†æ–‡ä»¶...";

          // å†™å…¥æ–‡ä»¶åˆ°FFmpeg
          ffmpeg.FS(
            "writeFile",
            "input." + getFileExtension(originalFile.name),
            await fetchFile(originalFile)
          );

          // è·å–å¤„ç†å‚æ•°
          const videoAction = document.getElementById("videoAction").value;
          const outputFormat = document.getElementById("outputFormat").value;
          const startTime = document.getElementById("startTime").value;
          const endTime = document.getElementById("endTime").value;
          const quality = document.getElementById("quality").value;

          let command = [];

          // æ ¹æ®é€‰æ‹©çš„å¤„ç†ç±»å‹æ„å»ºå‘½ä»¤
          if (videoAction === "convert") {
            command = [
              "-i",
              `input.${getFileExtension(originalFile.name)}`,
              "-c",
              "copy",
              `output.${outputFormat}`,
            ];
          } else if (videoAction === "extractAudio") {
            command = [
              "-i",
              `input.${getFileExtension(originalFile.name)}`,
              "-vn",
              "-acodec",
              "libmp3lame",
              "output.mp3",
            ];
          } else if (videoAction === "compress") {
            command = [
              "-i",
              `input.${getFileExtension(originalFile.name)}`,
              "-crf",
              quality,
              `output.${outputFormat}`,
            ];
          } else if (videoAction === "trim") {
            command = [
              "-i",
              `input.${getFileExtension(originalFile.name)}`,
              "-ss",
              startTime,
              "-to",
              endTime,
              "-c",
              "copy",
              `output.${outputFormat}`,
            ];
          }

          // æ‰§è¡ŒFFmpegå‘½ä»¤
          await ffmpeg.run(...command);

          // è¯»å–è¾“å‡ºæ–‡ä»¶
          const data = ffmpeg.FS("readFile", `output.${outputFormat}`);

          // åˆ›å»ºBlobå¹¶é¢„è§ˆ
          const blob = new Blob([data.buffer], {
            type: getMimeType(outputFormat),
          });
          previewFile(blob, "processedPreview");

          // åˆ›å»ºä¸‹è½½é“¾æ¥
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `processed.${outputFormat}`;
          a.textContent = "ç‚¹å‡»ä¸‹è½½å¤„ç†åçš„æ–‡ä»¶";
          a.style.display = "block";
          a.style.marginTop = "10px";

          document.getElementById("processedPreview").appendChild(a);

          document.getElementById("status").textContent = "å¤„ç†å®Œæˆï¼";
        } catch (error) {
          console.error("å¤„ç†å¤±è´¥:", error);
          document.getElementById("status").textContent =
            "å¤„ç†å¤±è´¥: " + error.message;
        }
      }

      function getFileExtension(filename) {
        return filename.split(".").pop().toLowerCase();
      }

      function getMimeType(extension) {
        const mimeTypes = {
          mp4: "video/mp4",
          webm: "video/webm",
          avi: "video/x-msvideo",
          mov: "video/quicktime",
          mp3: "audio/mpeg",
          wav: "audio/wav",
          ogg: "audio/ogg",
          aac: "audio/aac",
        };
        return mimeTypes[extension] || "application/octet-stream";
      }

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      window.addEventListener("load", initFFmpeg);
    </script>
  </body>
</html>
